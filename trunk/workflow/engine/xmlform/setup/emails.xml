<?xml version="1.0" encoding="UTF-8"?>
<dynaForm name="processes_New" width="400px" labelWidth="40%">

<THETITLE type="title" group="1">
  <en>Configuration</en>
</THETITLE>

<MESS_ENABLED type="checkbox" value="1">
  <en>Enable send mails</en>
</MESS_ENABLED>

<MESS_ENGINE type="dropdown">
  <en>Email Engine
    <option name="MAIL">Mail (PHP)</option>
    <option name="PHPMAILER">SMTP (PHPMailer)</option>
    <option name="OPENMAIL">SMTP without authentication (OpenMail)</option>
  </en>
</MESS_ENGINE>

<MESS_SERVER type="text" size="25" maxlength="100" required="true">
  <en>Server</en>
</MESS_SERVER>

<MESS_PORT type="text" size="5" maxlength="5" validate="Int">
  <en>Port</en>
</MESS_PORT>

<MESS_ACCOUNT type="text" size="25" maxlength="25" required="true" validate="Email">
  <en>Account</en>
</MESS_ACCOUNT>

<MESS_PASSWORD type="password" size="25" maxlength="25">
  <en>Password</en>
</MESS_PASSWORD>

<MESS_BACKGROUND type="checkbox" value="1">
  <en>Run in the background</en>
</MESS_BACKGROUND>

<MESS_EXECUTE_EVERY type="text" size="5" maxlength="5" required="true" validate="Int" defaultValue="5">
  <en>Execute every (in minutes)</en>
</MESS_EXECUTE_EVERY>

<MESS_SEND_MAX type="text" size="5" maxlength="5" required="true" validate="Int" defaultValue="50">
  <en>Maximun number of mails sended by attempt</en>
</MESS_SEND_MAX>

<MESS_TRY_SEND_INMEDIATLY type="checkbox" value="1">
  <en>Try send mails inmediatly</en>
</MESS_TRY_SEND_INMEDIATLY>

<TEST type="button" onclick="testEmailConfiguration();">
  <en>Test</en>
</TEST>

<SAVE_CHANGES type="button" onclick="verifyData(this.form);">
  <en>Save Changes</en>
</SAVE_CHANGES>

<JS type="javascript">
<![CDATA[
leimnud.event.add(getField('MESS_ENABLED'), 'click', function() {
  if (this.checked) {
    showRowById('MESS_ENGINE');
    switch (getField('MESS_ENGINE').value) {
      case 'MAIL':
        hideRowById('MESS_SERVER');
        hideRowById('MESS_PORT');
        hideRowById('MESS_ACCOUNT');
        hideRowById('MESS_PASSWORD');
      break;
      case 'PHPMAILER':
        showRowById('MESS_SERVER');
        showRowById('MESS_PORT');
        showRowById('MESS_ACCOUNT');
        showRowById('MESS_PASSWORD');
      break;
      case 'OPENMAIL':
        showRowById('MESS_SERVER');
        showRowById('MESS_PORT');
        hideRowById('MESS_ACCOUNT');
        hideRowById('MESS_PASSWORD');
      break;
    }
    showRowById('MESS_BACKGROUND');
    if (getField('MESS_BACKGROUND').checked) {
      showRowById('MESS_EXECUTE_EVERY');
      showRowById('MESS_SEND_MAX');
      showRowById('MESS_TRY_SEND_INMEDIATLY');
    }
    else {
      hideRowById('MESS_EXECUTE_EVERY');
      hideRowById('MESS_SEND_MAX');
      hideRowById('MESS_TRY_SEND_INMEDIATLY');
    }
    showRowById('TEST');
  }
  else {
    hideRowById('MESS_ENGINE');
    hideRowById('MESS_SERVER');
    hideRowById('MESS_PORT');
    hideRowById('MESS_ACCOUNT');
    hideRowById('MESS_PASSWORD');
    hideRowById('MESS_BACKGROUND');
    hideRowById('MESS_EXECUTE_EVERY');
    hideRowById('MESS_SEND_MAX');
    hideRowById('MESS_TRY_SEND_INMEDIATLY');
    hideRowById('TEST');
  }
}.extend(getField('MESS_ENABLED')));

leimnud.event.add(getField('MESS_ENGINE'), 'change', function() {
  switch (this.value) {
    case 'MAIL':
      hideRowById('MESS_SERVER');
      hideRowById('MESS_PORT');
      hideRowById('MESS_ACCOUNT');
      hideRowById('MESS_PASSWORD');
    break;
    case 'PHPMAILER':
      showRowById('MESS_SERVER');
      showRowById('MESS_PORT');
      showRowById('MESS_ACCOUNT');
      showRowById('MESS_PASSWORD');
    break;
    case 'OPENMAIL':
      hideRowById('MESS_ACCOUNT');
      hideRowById('MESS_PASSWORD');
    break;
  }
}.extend(getField('MESS_ENGINE')));

leimnud.event.add(getField('MESS_BACKGROUND'), 'click', function() {
  if (this.checked) {
    showRowById('MESS_EXECUTE_EVERY');
    showRowById('MESS_SEND_MAX');
    showRowById('MESS_TRY_SEND_INMEDIATLY');
  }
  else {
    hideRowById('MESS_EXECUTE_EVERY');
    hideRowById('MESS_SEND_MAX');
    hideRowById('MESS_TRY_SEND_INMEDIATLY');
  }
}.extend(getField('MESS_BACKGROUND')));

if (!getField('MESS_ENABLED').checked) {
  hideRowById('MESS_ENGINE');
  hideRowById('MESS_SERVER');
  hideRowById('MESS_PORT');
  hideRowById('MESS_ACCOUNT');
  hideRowById('MESS_PASSWORD');
  hideRowById('MESS_BACKGROUND');
  hideRowById('MESS_EXECUTE_EVERY');
  hideRowById('MESS_SEND_MAX');
  hideRowById('MESS_TRY_SEND_INMEDIATLY');
  hideRowById('TEST');
}

switch (getField('MESS_ENGINE').value) {
  case 'MAIL':
    hideRowById('MESS_SERVER');
    hideRowById('MESS_PORT');
    hideRowById('MESS_ACCOUNT');
    hideRowById('MESS_PASSWORD');
  break;
  case 'PHPMAILER':
    showRowById('MESS_SERVER');
    showRowById('MESS_PORT');
    showRowById('MESS_ACCOUNT');
    showRowById('MESS_PASSWORD');
  break;
  case 'OPENMAIL':
    hideRowById('MESS_ACCOUNT');
    hideRowById('MESS_PASSWORD');
  break;
}

if (!getField('MESS_BACKGROUND').checked) {
  hideRowById('MESS_EXECUTE_EVERY');
  hideRowById('MESS_SEND_MAX');
  hideRowById('MESS_TRY_SEND_INMEDIATLY');
}

var verifyData = function(oForm) {
  if (getField('MESS_ENABLED').checked) {
	  switch (getField('MESS_ENGINE').value) {
	    case 'PHPMAILER':
	      oAux = getField('MESS_SERVER');
	      if (oAux.value == '') {
	        alert(G_STRINGS.ID_MESS_SERVER_REQUIRED);
	        oAux.focus();
	        return;
	      }
	      oAux = getField('MESS_ACCOUNT');
	      if (oAux.value == '') {
	        alert(G_STRINGS.ID_MESS_ACCOUNT_REQUIRED);
	        oAux.focus();
	        return;
	      }
	    break;
	    case 'OPENMAIL':
	      oAux = getField('MESS_SERVER');
	      if (oAux.value == '') {
	        alert(G_STRINGS.ID_MESS_SERVER_REQUIRED);
	        oAux.focus();
	        return;
	      }
	    break;
	  }
	  if (getField('MESS_BACKGROUND').checked) {
	    oAux = getField('MESS_EXECUTE_EVERY');
	    if (oAux.value == '') {
	      alert(G_STRINGS.ID_MESS_EXECUTE_EVERY_REQUIRED);
	      oAux.focus();
	      return;
	    }
	    oAux = getField('MESS_SEND_MAX');
	    if (oAux.value == '') {
	      alert(G_STRINGS.ID_MESS_SEND_MAX_REQUIRED);
	      oAux.focus();
	      return;
	    }
	  }
	}
	oForm.submit();
};

var oPanel;

var testEmailConfiguration = function() {
  if (getField('MESS_ENGINE').value != 'MAIL') {
	  oAux = getField('MESS_SERVER');
	  if (oAux.value == '') {
	    alert(G_STRINGS.ID_MESS_SERVER_REQUIRED);
	    oAux.focus();
	    return;
	  }
	  oAux = getField('MESS_ACCOUNT');
	  if (oAux.value == '') {
	    alert(G_STRINGS.ID_MESS_ACCOUNT_REQUIRED);
	    oAux.focus();
	    return;
	  }
	}
  oPanel = new leimnud.module.panel();
  oPanel.options = {
  	size	:{w:300,h:200},
  	position:{x:0,y:0,center:true},
  	title	:"",
  	theme	:"processmaker",
  	statusBar:false,
  	control	:{resize:false,roll:false,drag:false},
  	fx	:{modal:true,opacity:true,blinkToFront:false,fadeIn:false,drag:false}
  };
  oPanel.events = {
  	remove: function() { delete(oPanel); }.extend(this)
  };
  oPanel.make();
  oPanel.loader.show();
  var oRPC = new leimnud.module.rpc.xmlhttp({
  	url : 'emails_Ajax',
  	args: 'action=testEmailConfiguration'
  });
  oRPC.callback = function(rpc){
    oPanel.loader.hide();
  	oPanel.addContent(rpc.xmlhttp.responseText);
  	var scs = rpc.xmlhttp.responseText.extractScript();
  	scs.evalScript();
  }.extend(this);
  oRPC.make();
};

var closeTestPanel = function() {
  oPanel.remove();
};
]]>
</JS>

</dynaForm>